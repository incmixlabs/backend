name: Migrate Prev Env

on:
  pull_request:
    branches:
      - main
    paths:
      - "api/*/migrations/*.sql"
      - ".github/workflows/prev-migrate.yaml"

jobs:
  migrate_auth:
    runs-on: ubuntu-latest
    name: Migrate Auth
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/migrate-d1
        with:
          workingDirectory: "api/auth"
          dbName: "lucia-auth-prev"
          envName: "--env prev"
  migrate_users:
    runs-on: ubuntu-latest
    name: Migrate Users
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/migrate-d1
        with:
          workingDirectory: "api/users-api"
          dbName: "users-api-dev-prev"
          envName: "--env prev"
  migrate_org:
    runs-on: ubuntu-latest
    name: Migrate Org
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/migrate-d1
        with:
          workingDirectory: "api/org-api"
          dbName: "org-api-dev-prev"
          envName: "--env prev"
  migrate_email:
    runs-on: ubuntu-latest
    name: Migrate Email
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/migrate-d1
        with:
          workingDirectory: "api/email"
          dbName: "email-api-dev-prev"
          envName: "--env prev"
  migrate_intl:
    runs-on: ubuntu-latest
    name: Migrate Intl
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/migrate-d1
        with:
          workingDirectory: "api/intl-api"
          dbName: "intl-api-dev-prev"
          envName: "--env prev"
  migrate_tasks:
    needs: [migrate_auth]
    runs-on: ubuntu-latest
    name: Migrate Tasks
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/migrate-d1
        with:
          workingDirectory: "api/tasks-api"
          dbName: "tasks-api-dev-prev"
          envName: "--env prev"
